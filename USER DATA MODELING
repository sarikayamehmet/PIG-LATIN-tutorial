-- loading event data

-- to find the count of rows
EVTDT= LOAD 'eventdata.csv' USING PigStorage(',') AS (EVTID,LAT,LONG);
EVTDT_GRP= GROUP EVTDT ALL;
EVT_COUNT = FOREACH EVTDT_GRP GENERATE COUNT(EVTDT);

-- to find count of unique evntID
EVTID = FOREACH EVTDT GENERATE EVTID;
DIST_EVTID = DISTINCT EVTID;
DIST_EVTID_GRP = GROUP DIST_EVTID ALL;
EVTID_COUNT = FOREACH DIST_EVTID_GRP GENERATE COUNT(DIST_EVTID);

-- USER DATA

-- to find the count of rows
USRDT= LOAD 'UserData.csv' USING PigStorage(',') AS (USRID,LAT,LONG);
USRDT_GRP= GROUP USRDT ALL;
USR_COUNT = FOREACH USRDT_GRP GENERATE COUNT(USRDT);

-- to find count of unique evntID
USRID = FOREACH USRDT GENERATE USRID;
DIST_USRID = DISTINCT USRID;
DIST_USRID_GRP = GROUP DIST_USRID ALL;
USRID_COUNT = FOREACH DIST_USRID_GRP GENERATE COUNT(DIST_USRID);

-- load USER RATINGS DATA
USRTG= LOAD 'UserRatings.csv' USING PigStorage(',') AS (USRID,EVTID,RTG);

-- USERRATINGS

--- USERRATINGS
EVTDT= LOAD 'eventdata.csv' USING PigStorage(',') AS (EVTID:INT,LAT:DOUBLE,LONG:DOUBLE);
USRDT= LOAD 'UserData.csv' USING PigStorage(',') AS (USRID:INT,LAT:DOUBLE,LONG:DOUBLE);
USRTG= LOAD 'UserRatings.csv' USING PigStorage(',') AS (USRID:INT,EVTID:INT,RTG:INT);
USRATT = LOAD 'AttendanceData.csv' USING PigStorage(',') AS (USRID:INT,EVTID:INT,TOA:CHARARRAY);

USRTG_EVTLOC = JOIN USRTG BY EVTID, EVTDT BY EVTID;
USRTG_EVTLOC_1 = FOREACH USRTG_EVTLOC GENERATE $0,$1,$2,$4,$5;

USRTG_USREVTLOC_1 = JOIN USRTG_EVTLOC_1 BY USRTG::USRID, USRDT BY USRID;
USRTG_USREVTLOC = FOREACH USRTG_USREVTLOC_1 GENERATE $0 AS USRID,$1 AS EVTID,$2 AS RATING,$3 AS EVT_LAT,$4 AS EVT_LONG,$6 AS USR_LAT,$7 AS USR_LONG;


USRTG_USREVTLOC_ATD_1 = JOIN USRTG_USREVTLOC BY (USRID,EVTID) FULL, USRATT BY (USRID,EVTID);
USRTG_USREVTLOC_ATD = FOREACH USRTG_USREVTLOC_ATD_1 GENERATE $0 AS USRID,$1 AS EVTID,$2 AS RATING,$3 AS EVT_LAT,$4 AS EVT_LONG,$5 AS USR_LAT,$6 AS USR_LONG,$9 AS TOA;


USR_EVT_GRP = GROUP USRTG_USREVTLOC BY (USRID,EVTID);
USR_EVT_GRP_CNT = FOREACH USR_EVT_GRP GENERATE group,COUNT(USRTG_USREVTLOC.USRID);
 
 

x = LIMIT USR_EVT_GRP_CNT 10;
dump x;

USRTG_USREVTLOC_ATD_GRP= GROUP USRTG_USREVTLOC_ATD ALL;
USRTG_USREVTLOC_ATD_COUNT = FOREACH USRTG_USREVTLOC_ATD_GRP GENERATE group,COUNT(USRTG_USREVTLOC_ATD.USRID);
DUMP USRTG_USREVTLOC_ATD_COUNT;

#JOIN RATINGS & ATTENDANCE
USRATT = LOAD 'uml/AttendanceData.csv' USING PigStorage(',') AS (USRID:INT,EVTID:INT,TOA:CHARARRAY);
USRTG= LOAD 'uml/UserRatings.csv' USING PigStorage(',') AS (USRID:INT,EVTID:INT,RTG:INT);
USRRTG_ATT = JOIN USRATT BY (USRID,EVTID) LEFT OUTER,USRTG BY (USRID,EVTID);
USRRTGATT = FOREACH USRRTG_ATT GENERATE USRATT::USRID AS UID,USRATT::EVTID AS EID,USRATT::TOA AS TOA,USRTG::RTG AS RTG;

USRRTGATT_GRPEVT = GROUP USRRTGATT BY (UID,EID);
GRPEVTCOUNT = FOREACH USRRTGATT_GRPEVT GENERATE group,COUNT(USRRTGATT.UID);
x = LIMIT GRPEVTCOUNT 40;
dump x;



